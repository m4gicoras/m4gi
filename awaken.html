<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>아이템 각성 시뮬레이터</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">아이템 각성 시뮬레이터 (무기/정령석)</h1>
    <form id="simulationForm" class="bg-white p-6 rounded shadow">
      <div class="mb-4">
        <label for="step" class="block text-gray-700">각성 단계 (4 또는 5)</label>
        <select id="step" name="step" class="mt-1 block w-full border-gray-300 rounded" required>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="targetOption" class="block text-gray-700">목표 옵션</label>
        <select id="targetOption" name="targetOption" class="mt-1 block w-full border-gray-300 rounded">
          <option value="">없음</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="targetValue" class="block text-gray-700">목표 옵션 수치</label>
        <input type="number" id="targetValue" name="targetValue" class="mt-1 block w-full border-gray-300 rounded" placeholder="예: 50">
      </div>
      <div class="text-center">
        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
          시뮬레이션 시작
        </button>
      </div>
    </form>
    <div id="resultContainer" class="mt-6"></div>
  </div>

  <script>

    const OPTION_LIST = [
      [586, [5, 25]], [587, [1, 2]], [462, [3, 13]], [461, [3, 13]], [585, [3, 13]],
      [464, [3, 13]], [594, [250, 1000]], [26, [250, 1000]], [18, [250, 1000]],
      [455, [250, 1000]], [496, [250, 1000]], [570, [250, 1000]], [566, [250, 1000]],
      [494, [5, 20]], [567, [2, 5]], [571, [2, 5]], [586, [20, 50]], [587, [1, 5]],
      [462, [7, 25]], [461, [7, 25]], [585, [7, 25]], [464, [7, 25]], [594, [200, 2000]],
      [26, [200, 2000]], [18, [200, 2000]], [455, [200, 2000]], [496, [200, 2000]],
      [570, [200, 2000]], [566, [200, 2000]], [494, [5, 30]], [567, [2, 8]], [571, [2, 8]],
      [586, [20, 100]], [587, [1, 8]], [462, [7, 40]], [461, [7, 40]], [585, [7, 40]],
      [464, [7, 40]], [465, [1, 1]], [465, [1, 1]], [465, [1, 1]]
    ];

    const OPTION_NAME = {
      586: "무기 공격력/속성력 +d",
      587: "무기 공격력/속성력 +d%",
      462: "물리/마법 최소대미지 +d%",
      461: "물리/마법 최대대미지 +d%",
      585: "최소/최대 대미지 +d%",
      464: "물리/마법 크리티컬 대미지 +d%",
      594: "근력/마법력 +d",
      26: "체력 +d",
      18: "행운 +d",
      455: "올스탯 +d",
      496: "물리/마법 고정 대미지 +d",
      570: "보스 몬스터 추가 대미지 +d",
      566: "일반 몬스터 추가 대미지 +d",
      494: "물리/마법 백어택 대미지 +d%",
      567: "일반 몬스터 추가 대미지 +d%",
      571: "보스 몬스터 추가 대미지 +d%",
      465: "물리/마법 크리티컬 확률 +d%"
    };

    const targetOptionSelect = document.getElementById("targetOption");
    for (const key in OPTION_NAME) {
      const optionElem = document.createElement("option");
      optionElem.value = OPTION_NAME[key];
      optionElem.textContent = OPTION_NAME[key];
      targetOptionSelect.appendChild(optionElem);
    }

    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    function simulateAwakening(step, targetOption, targetValue) {
      let sectionProbabilities, costPerAttempt;
      if (step === 4) {
        sectionProbabilities = [100, 95, 45, 25];
        costPerAttempt = 200_000_000;
      } else if (step === 5) {
        sectionProbabilities = [100, 100, 50, 30];
        costPerAttempt = 400_000_000;
      } else {
        return { error: "올바른 각성 단계를 선택해주세요. (4 또는 5)" };
      }

      if (!targetOption || !targetValue) {
        const appliedOptions = [];
        sectionProbabilities.forEach(prob => {
          if (randInt(1, 100) <= prob) {
            const [optionId, range] = OPTION_LIST[randInt(0, OPTION_LIST.length - 1)];
            const optionValue = randInt(range[0], range[1]);
            const optionText = OPTION_NAME[optionId].replace("d", optionValue);
            appliedOptions.push(optionText);
          }
        });
        return {
          step,
          cost: costPerAttempt,
          appliedOptions,
          isTargetSim: false
        };
      } else {

        let totalCost = 0, attempts = 0, success = false, accumulatedValue = 0;
        let appliedOptions = [];

        let targetOptionId = null;
        for (const key in OPTION_NAME) {
          if (OPTION_NAME[key] === targetOption) {
            targetOptionId = parseInt(key);
            break;
          }
        }
        if (targetOptionId === null) {
          return { error: `입력한 목표 옵션 '${targetOption}'을 찾을 수 없습니다.` };
        }

        while (!success) {
          attempts++;
          totalCost += costPerAttempt;
          appliedOptions = [];
          accumulatedValue = 0;

          for (const prob of sectionProbabilities) {
            if (randInt(1, 100) <= prob) {
              const [optionId, range] = OPTION_LIST[randInt(0, OPTION_LIST.length - 1)];
              const optionValue = randInt(range[0], range[1]);
              const optionText = OPTION_NAME[optionId].replace("d", optionValue);
              appliedOptions.push(optionText);

              if (optionId === targetOptionId) {
                accumulatedValue += optionValue;
              }
              if (accumulatedValue >= targetValue) {
                success = true;
                break;
              }
            } else {
              break;
            }
          }
          if (attempts > 10000) {
            return { error: "10,000번 시도해도 목표 옵션을 찾지 못했습니다. 다시 시도해주세요." };
          }
        }
        return {
          step,
          targetOption,
          targetValue,
          attempts,
          totalCost,
          appliedOptions,
          isTargetSim: true
        };
      }
    }

    document.getElementById("simulationForm").addEventListener("submit", function(event) {
      event.preventDefault();
      const step = parseInt(document.getElementById("step").value);
      const targetOption = document.getElementById("targetOption").value;
      const targetValueInput = document.getElementById("targetValue").value;
      const targetValue = targetValueInput ? parseInt(targetValueInput) : null;

      const result = simulateAwakening(step, targetOption, targetValue);
      displayResult(result);
    });

    function displayResult(result) {
      const container = document.getElementById("resultContainer");
      container.innerHTML = "";
      if (result.error) {
        container.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">${result.error}</div>`;
        return;
      }
      let html = `<div class="bg-white p-6 rounded shadow">`;
      html += `<p class="mb-2"><strong>각성 단계:</strong> ${result.step}</p>`;
      if (result.isTargetSim) {
        html += `<p class="mb-2"><strong>목표 옵션:</strong> ${result.targetOption.replace("d", result.targetValue)}</p>`;
        html += `<p class="mb-2"><strong>진행 횟수:</strong> ${result.attempts}회</p>`;
        html += `<p class="mb-2"><strong>총 소모 비용:</strong> ${result.totalCost.toLocaleString()} Ely</p>`;
      } else {
        html += `<p class="mb-2"><strong>소모 비용:</strong> ${result.cost.toLocaleString()} Ely</p>`;
      }
      html += `<hr class="my-4">`;
      if (result.appliedOptions.length > 0) {
        html += `<p class="mb-2 font-bold">부여된 옵션:</p><ul class="list-disc pl-5">`;
        result.appliedOptions.forEach(opt => {
          html += `<li>${opt}</li>`;
        });
        html += `</ul>`;
      } else {
        html += `<p class="text-red-600 font-bold">각성에 실패하여 옵션이 부여되지 않았습니다.</p>`;
      }
      html += `</div>`;
      container.innerHTML = html;
    }
  </script>
</body>
</html>
